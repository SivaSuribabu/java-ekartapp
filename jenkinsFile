pipeline{
    agent any

    tools{
        java 'jdk17'
        maven 'maven'
    }

    stages{

        stage('SCM checkout'){
            steps{
                git branch: 'main', url: 'https://github.com/SivaSuribabu/java-ekartapp.git'
            }
        }

        stage('Code Compilation'){
            steps{
                sh 'mvn compile'
            }
        }

        stage('Unit Test'){
            steps{
                sh 'mvn test -DskipTest=true'
            }
        }

        stage('SAST static code analysis'){
            environment{
                SONAR_URL = "http://172.17.0.1:9000/"
            }
            steps{
                withSonarQubeEnv(credentialsId: 'sonar-cred' variable:'SONAR_AUTH_TOKEN') {
                    sh 'mvn sonar:sonar -Dsonar.login=$SONAR_AUTH_TOKEN -Dsonar.host.url=${SONAR_URL}'
                        }
            }
        }

        stage('OWASP dependency check'){
            steps{
                dependencyCheck additionalArguments: ' --scan ./ ', odcInstallation: 'DC'
                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
            }
        }

        stage('Packaging project'){
            steps{
                sh 'mvn package -DskipTests=true'
            }
        }
    }
}